## =============================================================================
## TABLE 7: GLOBALIZATION TEST - BIS FOREIGN BANK CREDIT EXPOSURE
## =============================================================================

# 1. ENVIRONMENT SETUP
rm(list=ls()) 
graphics.off()
cat("\014")

library(readxl)
library(dplyr)
library(plm)
library(lmtest)
library(sandwich)
library(stargazer)

## ---- 2. DATA IMPORT ----
file_path <- "/Users/nominenkhmunkh/Documents/Documents/Ohm/thesis/data/Results_Decade/Table4_Regression/Master_data.xlsx"

growth  <- read_excel(file_path, sheet = "growth")
ex_dep  <- read_excel(file_path, sheet = "ex_dep")
fin_dev <- read_excel(file_path, sheet = "fin_dev")

## ---- 3. DATA CLEANING & MERGING ----
# Filter for 'All' firms to match your main methodology
ex_dep <- ex_dep %>% filter(trimws(firm_type) == "All")

growth$isic_code     <- as.character(growth$isic_code)
ex_dep$isic_code     <- as.character(ex_dep$isic_code)
growth$period        <- as.character(growth$period)
ex_dep$period        <- as.character(ex_dep$period)
fin_dev$period       <- as.character(fin_dev$period)
fin_dev$country_code <- as.character(fin_dev$country_code)

# Merge datasets and create interactions for Table 7
master_data <- growth %>%
  left_join(ex_dep,  by = c("isic_code", "period")) %>%
  left_join(fin_dev, by = c("country_code", "period")) %>%
  mutate(
    # Ensure numeric types for the BIS and Domestic credit variables
    across(c(external_dependence, domcre_gdp, con_claim), as.numeric),
    # Key Interaction: External Dependence x BIS Foreign Claims
    int_foreign = external_dependence * con_claim,
    # Interaction: External Dependence x Domestic Credit
    int_domcred = external_dependence * domcre_gdp,
    country_code = factor(country_code),
    isic_code    = factor(isic_code)
  )

## ---- 4. ANALYSIS FUNCTION (Table 7 Structure) ----
run_table7_analysis <- function(df, per) {
  
  d_sub <- df %>% filter(period == per)
  if(nrow(d_sub) < 10) return(NULL)
  
  pd <- pdata.frame(d_sub, index = "country_code")
  
  # Models match your screenshot: (1) Foreign Finance Only, (2) Joint Domestic + Foreign
  m1 <- plm(growth ~ industry_share + int_foreign + isic_code, data = pd, model = "within")
  m2 <- plm(growth ~ industry_share + int_foreign + int_domcred + isic_code, data = pd, model = "within")
  
  # Calculate Economic Magnitude (Differentials)
  d_ext <- diff(quantile(d_sub$external_dependence, c(0.25, 0.75), na.rm=T))
  d_for <- diff(quantile(d_sub$con_claim, c(0.25, 0.75), na.rm=T))
  d_dom <- diff(quantile(d_sub$domcre_gdp, c(0.25, 0.75), na.rm=T))
  
  diff_f <- c(as.numeric(coef(m1)["int_foreign"] * d_ext * d_for),
              as.numeric(coef(m2)["int_foreign"] * d_ext * d_for))
  
  diff_d <- c(NA, 
              as.numeric(coef(m2)["int_domcred"] * d_ext * d_dom))
  
  # Explicitly pull Adjusted R-squared to account for Fixed Effects degrees of freedom
  adj_r2 <- c(summary(m1)$r.squared["adjrsq"], 
              summary(m2)$r.squared["adjrsq"])
  
  return(list(period = per, models = list(m1, m2), diff_f = diff_f, diff_d = diff_d, adj_r2 = adj_r2))
}

## ---- 5. EXECUTION & PRINTING ----
# 2020-2024 is excluded from this globalization test extension
periods <- c("1990-1999", "2000-2009", "2010-2019")
results <- lapply(periods, function(p) run_table7_analysis(master_data, p))

for(res in results) {
  if(is.null(res)) next
  
  # Clustered standard errors by country (group)
  se_list <- lapply(res$models, function(m) {
    sqrt(diag(vcovHC(m, type = "HC1", cluster = "group")))
  })
  
  cat("\n\n", paste(rep("=", 65), collapse=""), "\n")
  cat("  PERIOD:", res$period, "\n")
  cat(paste(rep("=", 65), collapse=""), "\n")
  
  stargazer(res$models, 
            type = "text", 
            se = se_list, 
            column.labels = c("Foreign Finance", "Domestic + Foreign"),
            omit = "isic_code", 
            covariate.labels = c("Industry Share", "ED x Foreign Claims", "ED x Dom Credit"),
            add.lines = list(
              c("Industry Fixed Effects", "Yes", "Yes"),
              c("Adj. R-squared", round(res$adj_r2, 5)), 
              c("Diff in Growth (Foreign)", round(res$diff_f, 5)),
              c("Diff in Growth (Domestic)", round(res$diff_d, 5))
            ),
            keep.stat = c("n"), 
            notes = "Standard errors clustered by country. Adj R-squared accounts for fixed effects degrees of freedom.",
            digits = 5)
}
